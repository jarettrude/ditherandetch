---
import Icon from './Icon.astro';

const navItems = [
  { href: '/gallery', label: 'Gallery' },
  { href: '/contact', label: 'Contact' },
  { href: '/tools', label: 'Tools' },
  { href: '/journal', label: 'Journal' },
];

const { url } = Astro;
const currentPath = url.pathname;
---

<header
  class="sticky top-0 z-50 border-b border-border bg-surface/90 backdrop-blur-md"
>
  <nav
    class="mx-auto flex max-w-6xl items-center justify-between px-4 py-4 sm:px-6 lg:px-8"
    aria-label="Main navigation"
  >
    <!-- Logo -->
    <a
      href="/"
      class="brand-lockup brand-link flex h-12 items-center text-2xl transition-colors hover:text-accent"
      aria-label="Dither & Etch"
    >
      <span>Dither</span>
      <span class="brand-lockup-ampersand">&</span>
      <span>Etch</span>
    </a>

    <!-- Desktop Nav -->
    <div class="hidden items-center gap-8 md:flex">
      <ul class="flex items-center gap-8">
        {
          navItems.map(item => (
            <li>
              <a
                href={item.href}
                class:list={[
                  'nav-link flex h-12 items-center text-md font-medium transition-colors',
                  (
                    currentPath === item.href
                    || currentPath.startsWith(item.href + '/')
                  ) ?
                    'text-accent'
                  : 'text-ink-muted hover:text-ink',
                ]}
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>

      <!-- Theme Toggle -->
      <button
        type="button"
        id="theme-toggle"
        class="flex h-12 w-12 items-center justify-center rounded-sm text-ink-muted transition-colors hover:bg-surface-raised hover:text-ink"
        aria-label="Toggle theme"
      >
        <Icon
          name="sun"
          class="h-6 w-6 hidden [html:not([data-theme])_&]:block"
        />
        <Icon
          name="moon"
          class="h-6 w-6 hidden [html[data-theme='light']_&]:block"
        />
      </button>
    </div>

    <!-- Mobile Menu Button -->
    <button
      type="button"
      id="mobile-menu-btn"
      class="flex h-12 w-12 items-center justify-center rounded-lg text-ink-muted transition-colors hover:bg-surface-raised hover:text-ink md:hidden"
      aria-label="Open menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <Icon name="menu" class="h-6 w-6 icon-menu" />
      <Icon name="close" class="h-6 w-6 hidden icon-close" />
    </button>
  </nav>
</header>

<!-- Mobile Menu -->
<div
  id="mobile-menu"
  class="fixed inset-x-0 top-[81px] bottom-0 z-40 hidden flex-col bg-surface/95 backdrop-blur-xl px-4 pb-8 md:hidden shadow-lg"
>
  <ul class="flex flex-col gap-2 pt-6">
    {
      navItems.map(item => (
        <li>
          <a
            href={item.href}
            class:list={[
              'nav-link-mobile',
              (
                currentPath === item.href
                || currentPath.startsWith(item.href + '/')
              ) ?
                'text-accent'
              : 'text-ink-muted',
            ]}
          >
            {item.label}
          </a>
        </li>
      ))
    }
  </ul>

  <div
    class="mt-auto flex items-center justify-between border-t border-border pt-6"
  >
    <span class="text-md font-medium text-ink-muted">Theme</span>
    <button
      type="button"
      id="theme-toggle-mobile"
      class="flex h-12 w-12 items-center justify-center rounded-lg text-ink-muted transition-colors hover:bg-surface-raised hover:text-ink"
      aria-label="Toggle theme"
    >
      <Icon
        name="sun"
        class="h-6 w-6 hidden [html:not([data-theme])_&]:block"
      />
      <Icon
        name="moon"
        class="h-6 w-6 hidden [html[data-theme='light']_&]:block"
      />
    </button>
  </div>
</div>

<script>
  function initHeader() {
    const mobileMenuBtn = document.getElementById(
      'mobile-menu-btn',
    ) as HTMLButtonElement | null;
    const mobileMenu = document.getElementById('mobile-menu');
    const siteRoot = document.getElementById('site-root');
    const themeToggles = [
      document.getElementById('theme-toggle'),
      document.getElementById('theme-toggle-mobile'),
    ];

    function toggleMenu(force?: boolean) {
      if (!mobileMenu || !mobileMenuBtn || !siteRoot) return;

      const isOpen =
        force !== undefined ? force : mobileMenu.classList.contains('hidden');

      if (isOpen) {
        // Open
        mobileMenu.classList.remove('hidden');
        mobileMenuBtn.setAttribute('aria-expanded', 'true');
        mobileMenuBtn.setAttribute('aria-label', 'Close menu');
        document.body.style.overflow = 'hidden';
        // Set inert on background content to trap focus
        document.getElementById('main')?.setAttribute('inert', '');
        document.querySelector('footer')?.setAttribute('inert', '');
        document.querySelector('astro-island')?.setAttribute('inert', '');
        // Toggle icons
        const menuIcon = mobileMenuBtn.querySelector('.icon-menu');
        const closeIcon = mobileMenuBtn.querySelector('.icon-close');
        if (menuIcon && closeIcon) {
          menuIcon.classList.add('hidden');
          closeIcon.classList.remove('hidden');
        }
        // Small delay to ensure rendering before focus trap
        setTimeout(() => {
          const firstLink = mobileMenu.querySelector('a');
          firstLink?.focus();
        }, 10);
      } else {
        // Close
        mobileMenu.classList.add('hidden');
        mobileMenuBtn.setAttribute('aria-expanded', 'false');
        mobileMenuBtn.setAttribute('aria-label', 'Open menu');
        document.body.style.overflow = '';
        // Remove inert from background content
        document.getElementById('main')?.removeAttribute('inert');
        document.querySelector('footer')?.removeAttribute('inert');
        document.querySelector('astro-island')?.removeAttribute('inert');
        // Toggle icons back
        const menuIcon = mobileMenuBtn.querySelector('.icon-menu');
        const closeIcon = mobileMenuBtn.querySelector('.icon-close');
        if (menuIcon && closeIcon) {
          menuIcon.classList.remove('hidden');
          closeIcon.classList.add('hidden');
        }
        mobileMenuBtn.focus();
      }
    }

    mobileMenuBtn?.addEventListener('click', () => toggleMenu());

    // Listeners for escape key and focus trapping
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        toggleMenu(false);
      }

      // Focus trapping
      if (
        e.key === 'Tab'
        && mobileMenu
        && !mobileMenu.classList.contains('hidden')
      ) {
        const focusables = mobileMenu.querySelectorAll('a, button');
        const first = focusables[0] as HTMLElement;
        const last = focusables[focusables.length - 1] as HTMLElement;

        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    });

    // Theme toggle
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? null : 'light';

      if (newTheme) {
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      } else {
        html.removeAttribute('data-theme');
        localStorage.removeItem('theme');
      }
    }

    themeToggles.forEach(btn => btn?.addEventListener('click', toggleTheme));
  }

  // Run on initial load
  initHeader();

  // Re-run after View Transitions
  document.addEventListener('astro:after-swap', initHeader);
</script>
